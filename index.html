<!doctype html>
<html lang="ja">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>言い訳メーカー</title>
  <style>
    body { font-family: system-ui, -apple-system, "Segoe UI", sans-serif; margin: 0; background:#f7f7f7; }
    .wrap { max-width: 720px; margin: 0 auto; padding: 16px; }
    .card { background:#fff; border-radius: 14px; padding: 16px; box-shadow: 0 6px 18px rgba(0,0,0,.06); }
    h1 { font-size: 18px; margin: 0 0 6px; }
    .sub { color:#666; font-size: 12px; margin-bottom: 14px; }
    .row { display:flex; gap:10px; flex-wrap:wrap; }
    select { flex:1; min-width: 160px; padding: 10px; border-radius: 10px; border:1px solid #ddd; background:#fff; }
    textarea { width:100%; height: 140px; padding: 12px; border-radius: 12px; border:1px solid #ddd; resize:none; font-size: 14px; line-height: 1.6; }
    .btns { display:flex; gap:10px; margin-top: 10px; flex-wrap:wrap; }
    button { padding: 10px 12px; border:0; border-radius: 12px; background:#111; color:#fff; cursor:pointer; }
    button.secondary { background:#e9e9e9; color:#111; }
    .ad { margin-top: 14px; padding: 14px; border-radius: 12px; background:#fafafa; border:1px dashed #ddd; color:#777; font-size:12px; text-align:center; }
    .foot { margin-top: 14px; color:#777; font-size: 11px; line-height:1.6; }
  </style>
</head>
<body>
  <div class="wrap">
    <div class="card">
      <h1>言い訳メーカー</h1>
      <div class="sub">カテゴリ・用途・温度感を選ぶだけ。文章が自動で出ます（ログイン不要）</div>

      <div class="row">
        <select id="category"></select>
        <select id="purpose"></select>
        <select id="tone"></select>
      </div>

      <div style="margin-top:12px;">
        <textarea id="output" readonly></textarea>
        <div class="btns">
          <button id="copy">コピー</button>
          <button id="reload" class="secondary">別案を出す</button>
        </div>
      </div>

      <div class="ad">広告枠（ここにAdSense等）</div>

      <div class="foot">
        ※本サービスは文章例を提供するもので、利用結果について責任を負いません。<br/>
        露骨な虚偽や違法行為を助長する用途には使用しないでください。
      </div>
    </div>
  </div>

<script>
/* ==========================
   設定
========================== */
let DATA = {};
const API_URL = "https://script.google.com/macros/s/AKfycbwNeCUdDOBk08fiQ7gZGoqccdbahhItNAQyWHcWyJ1ijKdsv3AvCiahvW9wcNsSN_4cug/exec";
const TONE_ORDER = ["丁寧", "普通", "ふざけた"];

/* ==========================
   DOM
========================== */
const elCategory = document.getElementById("category");
const elPurpose  = document.getElementById("purpose");
const elTone     = document.getElementById("tone");
const elOutput   = document.getElementById("output");
const btnReload  = document.getElementById("reload");
const btnCopy    = document.getElementById("copy");

let lastText = "";

/* ==========================
   Utility
========================== */
function pick(arr) {
  return arr[Math.floor(Math.random() * arr.length)];
}

/* ==========================
   API load
========================== */
async function loadTemplates() {
  const res = await fetch(API_URL, { cache: "no-store" });
  if (!res.ok) throw new Error("API error: " + res.status);
  DATA = await res.json();
}

/* ==========================
   Populate selects
========================== */
function populateCategories() {
  elCategory.innerHTML = "";
  Object.keys(DATA).forEach(cat => {
    const opt = document.createElement("option");
    opt.value = cat;
    opt.textContent = cat;
    elCategory.appendChild(opt);
  });
}

function populatePurposes() {
  const catNode = DATA[elCategory.value];
  elPurpose.innerHTML = "";
  Object.keys(catNode).forEach(pur => {
    const opt = document.createElement("option");
    opt.value = pur;
    opt.textContent = pur;
    elPurpose.appendChild(opt);
  });
}

function populateTones() {
  const catNode = DATA[elCategory.value];
  const purNode = catNode[elPurpose.value];
  const tones = Object.keys(purNode);

  const ordered = [
    ...TONE_ORDER.filter(t => tones.includes(t)),
    ...tones.filter(t => !TONE_ORDER.includes(t))
  ];

  elTone.innerHTML = "";
  ordered.forEach(t => {
    const opt = document.createElement("option");
    opt.value = t;
    opt.textContent = t;
    elTone.appendChild(opt);
  });

  if (ordered.includes("普通")) elTone.value = "普通";
}

/* ==========================
   Text generation
========================== */
function buildText() {
  const node = DATA[elCategory.value][elPurpose.value][elTone.value];

  const intro  = node.intro  || [];
  const reason = node.reason || [];
  const ending = node.ending || [];

  let text = [
    intro.length  ? pick(intro)  : "",
    reason.length ? pick(reason) : "",
    ending.length ? pick(ending) : ""
  ].filter(Boolean).join("\n");

  for (let i = 0; i < 5 && text === lastText; i++) {
    text = [
      intro.length  ? pick(intro)  : "",
      reason.length ? pick(reason) : "",
      ending.length ? pick(ending) : ""
    ].filter(Boolean).join("\n");
  }

  lastText = text;
  return text || "テンプレがありません。";
}

function generate() {
  elOutput.value = buildText();
}

/* ==========================
   Events
========================== */
elCategory.addEventListener("change", () => {
  populatePurposes();
  populateTones();
  generate();
});

elPurpose.addEventListener("change", () => {
  populateTones();
  generate();
});

elTone.addEventListener("change", generate);
btnReload.addEventListener("click", generate);

btnCopy.addEventListener("click", async () => {
  try {
    await navigator.clipboard.writeText(elOutput.value);
    const prev = btnCopy.textContent;
    btnCopy.textContent = "コピーしました";
    setTimeout(() => btnCopy.textContent = prev, 900);
  } catch {
    alert("コピーに失敗しました。");
  }
});

/* ==========================
   Init
========================== */
(async () => {
  try {
    await loadTemplates();
    populateCategories();
    populatePurposes();
    populateTones();
    generate();
  } catch (e) {
    console.error(e);
    elOutput.value = "テンプレの読み込みに失敗しました。";
  }
})();
</script>
</body>
</html>
